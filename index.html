<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Reef - Water Structure Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #001122, #003355, #001a33);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: white;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            background: radial-gradient(circle at center, rgba(0,50,100,0.3), rgba(0,20,40,0.8));
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,30,60,0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(100,200,255,0.3);
            box-shadow: 0 8px 32px rgba(0,100,200,0.2);
            max-width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #66ccff;
        }

        input[type="text"], select {
            width: 200px;
            padding: 8px;
            background: rgba(0,50,100,0.5);
            border: 1px solid rgba(100,200,255,0.3);
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }

        input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type="range"] {
            width: 200px;
        }

        button {
            background: linear-gradient(45deg, #0066cc, #0099ff);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(45deg, #0080ff, #00aaff);
            transform: translateY(-2px);
        }

        .main-title {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 100;
        }

        .main-title h1 {
            font-size: 48px;
            background: linear-gradient(45deg, #66ccff, #99ddff, #ccf0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(102,204,255,0.5);
            font-weight: bold;
            letter-spacing: 3px;
        }

        .main-title p {
            font-size: 16px;
            color: #99ccff;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .brand-corner {
            position: absolute;
            bottom: 20px;
            right: 20px;
            text-align: center;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .brand-logo {
            width: 50px;
            height: 50px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 10px rgba(138,43,226,0.4));
        }

        .brand-corner .brand-name {
            font-size: 14px;
            background: linear-gradient(45deg, #8a2be2, #da70d6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .brand-corner .brand-subtitle {
            font-size: 8px;
            color: #cc99ff;
            opacity: 0.7;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .sound-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .frequency-display {
            font-size: 11px;
            color: #88ccff;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        
        <div class="main-title">
            <h1>CORAL REEF</h1>
            <p>Water Structure Visualizer</p>
        </div>

        <div class="brand-corner">
            <svg class="brand-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Outer glow effect -->
                <defs>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    <filter id="uvGlow">
                        <feGaussianBlur stdDeviation="4" result="uvBlur"/>
                        <feFlood flood-color="#8a2be2" flood-opacity="0.8"/>
                        <feComposite in2="uvBlur" operator="in"/>
                        <feMerge> 
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    <linearGradient id="dropGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#4da6ff;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#0080ff;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#003d7a;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="purpleFlame" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#da70d6;stop-opacity:0.9" />
                        <stop offset="30%" style="stop-color:#9932cc;stop-opacity:0.8" />
                        <stop offset="70%" style="stop-color:#6a0dad;stop-opacity:0.7" />
                        <stop offset="100%" style="stop-color:#4b0082;stop-opacity:0.6" />
                    </linearGradient>
                    <linearGradient id="flameHighlight" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.4" />
                        <stop offset="50%" style="stop-color:#e6ccff;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#cc99ff;stop-opacity:0.2" />
                    </linearGradient>
                </defs>
                
                <!-- Main water drop shape with UV glow -->
                <path d="M100 30 C130 30, 160 60, 160 100 C160 140, 130 170, 100 170 C70 170, 40 140, 40 100 C40 60, 70 30, 100 30 Z" 
                      fill="url(#dropGradient)" 
                      stroke="#8a2be2" 
                      stroke-width="3" 
                      filter="url(#uvGlow)"/>
                
                <!-- Purple flame shape -->
                <path d="M100 60 C115 60, 130 75, 130 95 C130 115, 115 130, 100 130 C85 130, 70 115, 70 95 C70 75, 85 60, 100 60 Z" 
                      fill="url(#purpleFlame)"/>
                
                <!-- Flame flicker effect -->
                <path d="M95 65 C100 62, 105 65, 110 70 C115 75, 112 85, 107 90 C105 95, 100 100, 95 95 C90 90, 88 80, 92 75 C94 70, 95 65, 95 65 Z" 
                      fill="url(#flameHighlight)">
                      <animateTransform
                        attributeName="transform"
                        attributeType="XML"
                        type="scale"
                        values="1 1;1.1 0.9;1 1;0.9 1.1;1 1"
                        dur="2s"
                        repeatCount="indefinite"/>
                </path>
                
                <!-- Inner flame highlight -->
                <path d="M100 70 C108 70, 115 77, 115 87 C115 97, 108 104, 100 104 C92 104, 85 97, 85 87 C85 77, 92 70, 100 70 Z" 
                      fill="rgba(255,255,255,0.3)"/>
            </svg>
            
            <div class="brand-name">AQUA IGNIS</div>
            <div class="brand-subtitle">Powered By</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Color Palette</label>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label style="font-size: 9px; margin-bottom: 3px;">Primary</label>
                        <input type="color" id="colorInput1" value="#66ccff">
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label style="font-size: 9px; margin-bottom: 3px;">Secondary</label>
                        <input type="color" id="colorInput2" value="#ff6699">
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label style="font-size: 9px; margin-bottom: 3px;">Accent</label>
                        <input type="color" id="colorInput3" value="#99ff66">
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="randomizeColors()" style="flex: 1; font-size: 10px; padding: 5px;">Random</button>
                    <button onclick="harmonicColors()" style="flex: 1; font-size: 10px; padding: 5px;">Harmonic</button>
                </div>
            </div>

            <div class="control-group">
                <label>Formation Shape</label>
                <select id="shapeInput">
                    <option value="hexagon">Hexagon</option>
                    <option value="triangle">Triangle</option>
                    <option value="circle">Circle</option>
                    <option value="square">Square</option>
                    <option value="star">Star</option>
                </select>
            </div>

            <div class="control-group">
                <label>🌊 Multi-Wave Synthesizer</label>
                <div style="background: rgba(100,200,255,0.1); padding: 15px; border-radius: 10px; margin-top: 10px;">
                    <div class="master-controls">
                        <label style="font-size: 11px; margin-bottom: 5px;">Master Controls</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button id="playAll" style="flex: 1;">Play All</button>
                            <button id="stopAll" style="flex: 1;">Stop All</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 10px;">Master Volume</label>
                            <input type="range" id="masterVolume" min="0" max="100" value="30" style="width: 100%;">
                            <div class="frequency-display">30%</div>
                        </div>
                        
                        <!-- Preset Frequencies -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 10px; margin-bottom: 5px;">Healing Frequency Presets</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                <button onclick="loadPreset('solfeggio')" style="font-size: 9px; padding: 4px 8px;">Solfeggio</button>
                                <button onclick="loadPreset('schumann')" style="font-size: 9px; padding: 4px 8px;">Schumann</button>
                                <button onclick="loadPreset('planetary')" style="font-size: 9px; padding: 4px 8px;">Planetary</button>
                            </div>
                        </div>
                        
                        <!-- Frequency Spectrum Display -->
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 10px; margin-bottom: 5px;">Active Frequencies</label>
                            <canvas id="spectrumCanvas" width="280" height="120" style="width: 100%; height: 80px; background: rgba(0,20,40,0.5); border-radius: 5px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Wave Generator 1 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave1Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 1</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave1Freq" min="0" max="20000" value="432" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave1Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave1Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 2 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave2Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 2</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave2Freq" min="0" max="20000" value="528" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave2Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave2Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 3 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave3Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 3</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave3Freq" min="0" max="20000" value="639" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave3Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave3Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 4 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave4Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 4</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave4Freq" min="0" max="20000" value="741" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave4Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave4Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 5 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave5Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 5</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave5Freq" min="0" max="20000" value="741" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave5Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave5Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 6 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave6Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 6</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave6Freq" min="0" max="20000" value="852" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave6Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave6Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 7 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave7Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 7</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave7Freq" min="0" max="20000" value="852" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave7Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave7Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Wave Generator 8 -->
                    <div class="wave-generator" style="background: rgba(0,50,100,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="wave8Enable" style="margin-right: 8px;">
                            <label style="font-size: 11px; font-weight: bold; color: #66ccff;">Wave 8</label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Frequency (Hz)</label>
                                <input type="number" id="wave8Freq" min="0" max="20000" value="963" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 9px;">Wave Type</label>
                                <select id="wave8Type" style="width: 100%; padding: 4px; background: rgba(0,30,60,0.5); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px; color: white; font-size: 12px;">
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="sawtooth">Sawtooth</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 9px;">Volume</label>
                            <input type="range" id="wave8Volume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Flow Intensity</label>
                <input type="range" id="intensitySlider" min="1" max="10" value="5">
            </div>

            <button onclick="resetVisualization()">Reset Matrix</button>
        </div>
    </div>

    <script>
        class MultiWaveSynth {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.oscillators = {};
                this.gainNodes = {};
                this.analyser = null;
                this.isPlaying = false;
                this.waveData = new Uint8Array(256);
            }

            async initialize() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 512;
                    
                    this.masterGain.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    
                    // Set initial master volume
                    this.masterGain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                } catch (error) {
                    console.error('Failed to initialize audio context:', error);
                }
            }

            startWave(waveNum) {
                if (!this.audioContext) return;

                const freq = parseInt(document.getElementById(`wave${waveNum}Freq`).value) || 0;
                const type = document.getElementById(`wave${waveNum}Type`).value;
                const volume = parseInt(document.getElementById(`wave${waveNum}Volume`).value) / 100;

                // Stop existing oscillator if running
                this.stopWave(waveNum);

                if (freq > 0) {
                    // Create oscillator and gain node
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();

                    oscillator.type = type;
                    oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(volume * 0.2, this.audioContext.currentTime); // Scale down for safety

                    oscillator.connect(gainNode);
                    gainNode.connect(this.masterGain);

                    oscillator.start();

                    // Store references
                    this.oscillators[waveNum] = oscillator;
                    this.gainNodes[waveNum] = gainNode;
                }
            }

            stopWave(waveNum) {
                if (this.oscillators[waveNum]) {
                    try {
                        this.oscillators[waveNum].stop();
                    } catch (e) {
                        // Oscillator might already be stopped
                    }
                    delete this.oscillators[waveNum];
                    delete this.gainNodes[waveNum];
                }
            }

            updateWave(waveNum) {
                if (!this.audioContext || !this.oscillators[waveNum]) return;

                const freq = parseInt(document.getElementById(`wave${waveNum}Freq`).value) || 0;
                const volume = parseInt(document.getElementById(`wave${waveNum}Volume`).value) / 100;

                if (freq > 0) {
                    this.oscillators[waveNum].frequency.setValueAtTime(freq, this.audioContext.currentTime);
                    this.gainNodes[waveNum].gain.setValueAtTime(volume * 0.2, this.audioContext.currentTime);
                }
            }

            setMasterVolume(volume) {
                if (this.masterGain) {
                    this.masterGain.gain.setValueAtTime(volume, this.audioContext.currentTime);
                }
            }

            playAll() {
                if (!this.audioContext) {
                    this.initialize().then(() => this.playAll());
                    return;
                }

                for (let i = 1; i <= 8; i++) {
                    const enabled = document.getElementById(`wave${i}Enable`).checked;
                    if (enabled) {
                        this.startWave(i);
                    }
                }
                this.isPlaying = true;
            }

            stopAll() {
                for (let i = 1; i <= 8; i++) {
                    this.stopWave(i);
                }
                this.isPlaying = false;
            }

            getAudioData() {
                if (this.analyser) {
                    this.analyser.getByteFrequencyData(this.waveData);
                    
                    // Calculate average amplitude
                    let sum = 0;
                    for (let i = 0; i < this.waveData.length; i++) {
                        sum += this.waveData[i];
                    }
                    return {
                        average: sum / this.waveData.length,
                        waveform: this.waveData,
                        isPlaying: this.isPlaying
                    };
                }
                return { average: 0, waveform: new Uint8Array(256), isPlaying: false };
            }
        }

        class Particle {
            constructor(x, y, colors, shape) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 6 + 2;
                this.originalSize = this.size;
                this.colors = colors;
                this.currentColorIndex = Math.floor(Math.random() * colors.length);
                this.color = colors[this.currentColorIndex];
                this.colorTransition = 0;
                this.targetColorIndex = this.currentColorIndex;
                this.shape = shape;
                this.life = 1.0;
                this.decay = Math.random() * 0.01 + 0.002;
                this.phase = Math.random() * Math.PI * 2;
                this.resonanceFreq = Math.random() * 1000 + 100; // Each particle has a resonance frequency
            }

            update(mouseX, mouseY, audioData, intensity) {
                // Multi-frequency audio response
                const audioInfluence = (audioData.average / 255) * (intensity / 10);
                
                // Resonance effect - particles respond more to frequencies near their resonance
                let resonanceEffect = 0;
                let dominantFrequency = 0;
                let maxResonance = 0;
                
                for (let i = 1; i <= 8; i++) {
                    if (document.getElementById(`wave${i}Enable`).checked) {
                        const freq = parseInt(document.getElementById(`wave${i}Freq`).value) || 0;
                        const volume = parseInt(document.getElementById(`wave${i}Volume`).value) / 100;
                        const resonanceDiff = Math.abs(freq - this.resonanceFreq);
                        const resonanceStrength = Math.max(0, 1 - (resonanceDiff / 500)) * volume;
                        resonanceEffect += resonanceStrength;
                        
                        // Track which frequency has the strongest influence for color changes
                        if (resonanceStrength > maxResonance) {
                            maxResonance = resonanceStrength;
                            dominantFrequency = freq;
                        }
                    }
                }
                
                // Color shifting based on frequency ranges
                if (audioInfluence > 0.1) {
                    if (dominantFrequency < 300) {
                        this.targetColorIndex = 0; // Low frequencies = primary color
                    } else if (dominantFrequency < 800) {
                        this.targetColorIndex = 1; // Mid frequencies = secondary color
                    } else {
                        this.targetColorIndex = 2; // High frequencies = accent color
                    }
                }
                
                // Smooth color transitions
                if (this.targetColorIndex !== this.currentColorIndex) {
                    this.colorTransition += 0.05;
                    if (this.colorTransition >= 1.0) {
                        this.currentColorIndex = this.targetColorIndex;
                        this.colorTransition = 0;
                    }
                }
                
                // Update current color with smooth interpolation
                if (this.colorTransition > 0) {
                    this.color = this.interpolateColor(
                        this.colors[this.currentColorIndex],
                        this.colors[this.targetColorIndex],
                        this.colorTransition
                    );
                } else {
                    this.color = this.colors[this.currentColorIndex];
                }
                
                // Size responds to resonance and audio
                this.size = this.originalSize * (1 + audioInfluence * 2 + resonanceEffect * 3);

                // Multi-wave movement influence
                let waveInfluenceX = 0;
                let waveInfluenceY = 0;
                
                for (let i = 1; i <= 8; i++) {
                    if (document.getElementById(`wave${i}Enable`).checked) {
                        const freq = parseInt(document.getElementById(`wave${i}Freq`).value) || 0;
                        const volume = parseInt(document.getElementById(`wave${i}Volume`).value) / 100;
                        const waveType = document.getElementById(`wave${i}Type`).value;
                        
                        if (freq > 0) {
                            const time = Date.now() * 0.001;
                            let waveValue = 0;
                            
                            switch(waveType) {
                                case 'sine':
                                    waveValue = Math.sin(time * freq * 0.01 + this.phase);
                                    break;
                                case 'square':
                                    waveValue = Math.sign(Math.sin(time * freq * 0.01 + this.phase));
                                    break;
                                case 'triangle':
                                    waveValue = (2 / Math.PI) * Math.asin(Math.sin(time * freq * 0.01 + this.phase));
                                    break;
                                case 'sawtooth':
                                    waveValue = 2 * ((time * freq * 0.01 + this.phase) % (2 * Math.PI)) / (2 * Math.PI) - 1;
                                    break;
                            }
                            
                            waveInfluenceX += waveValue * volume * 0.1;
                            waveInfluenceY += Math.cos(time * freq * 0.01 + this.phase + Math.PI/2) * volume * 0.1;
                        }
                    }
                }

                this.vx += waveInfluenceX * 0.02;
                this.vy += waveInfluenceY * 0.02;

                // Mouse attraction enhanced by audio
                const dx = mouseX - this.x;
                const dy = mouseY - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 150) {
                    const force = (150 - distance) / 150;
                    this.vx += (dx / distance) * force * 0.1 * (1 + audioInfluence);
                    this.vy += (dy / distance) * force * 0.1 * (1 + audioInfluence);
                }

                this.x += this.vx;
                this.y += this.vy;

                // Boundary wrapping
                if (this.x < 0) this.x = canvas.width;
                if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;

                // Damping
                this.vx *= 0.95;
                this.vy *= 0.95;

                this.life -= this.decay;
            }

            interpolateColor(color1, color2, factor) {
                const hex1 = color1.slice(1);
                const hex2 = color2.slice(1);
                
                const r1 = parseInt(hex1.substr(0, 2), 16);
                const g1 = parseInt(hex1.substr(2, 2), 16);
                const b1 = parseInt(hex1.substr(4, 2), 16);
                
                const r2 = parseInt(hex2.substr(0, 2), 16);
                const g2 = parseInt(hex2.substr(2, 2), 16);
                const b2 = parseInt(hex2.substr(4, 2), 16);
                
                const r = Math.round(r1 + (r2 - r1) * factor);
                const g = Math.round(g1 + (g2 - g1) * factor);
                const b = Math.round(b1 + (b2 - b1) * factor);
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }

            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.life * 0.7;
                ctx.fillStyle = this.color;
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 1;

                // Add resonance glow
                const resonanceGlow = this.size > this.originalSize * 2;
                if (resonanceGlow) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = this.color;
                }

                ctx.translate(this.x, this.y);

                switch(this.shape) {
                    case 'hexagon':
                        this.drawHexagon(ctx);
                        break;
                    case 'triangle':
                        this.drawTriangle(ctx);
                        break;
                    case 'circle':
                        this.drawCircle(ctx);
                        break;
                    case 'square':
                        this.drawSquare(ctx);
                        break;
                    case 'star':
                        this.drawStar(ctx);
                        break;
                }

                ctx.restore();
            }

            drawHexagon(ctx) {
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI) / 3;
                    const x = Math.cos(angle) * this.size;
                    const y = Math.sin(angle) * this.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
            }

            drawTriangle(ctx) {
                ctx.beginPath();
                ctx.moveTo(0, -this.size);
                ctx.lineTo(-this.size, this.size);
                ctx.lineTo(this.size, this.size);
                ctx.closePath();
                ctx.stroke();
            }

            drawCircle(ctx) {
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.stroke();
            }

            drawSquare(ctx) {
                ctx.strokeRect(-this.size/2, -this.size/2, this.size, this.size);
            }

            drawStar(ctx) {
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * Math.PI * 2) / 5 - Math.PI / 2;
                    const x = Math.cos(angle) * this.size;
                    const y = Math.sin(angle) * this.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    
                    const innerAngle = angle + Math.PI / 5;
                    const innerX = Math.cos(innerAngle) * this.size * 0.5;
                    const innerY = Math.sin(innerAngle) * this.size * 0.5;
                    ctx.lineTo(innerX, innerY);
                }
                ctx.closePath();
                ctx.stroke();
            }
        }

        // Setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let mouseX = 0;
        let mouseY = 0;
        let synth = new MultiWaveSynth();

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function createParticles() {
            particles = [];
            const particleCount = 150;
            const colors = [
                document.getElementById('colorInput1').value,
                document.getElementById('colorInput2').value,
                document.getElementById('colorInput3').value
            ];
            const shape = document.getElementById('shapeInput').value;
            
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    colors,
                    shape
                ));
            }
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 20, 40, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const intensity = parseInt(document.getElementById('intensitySlider').value);
            const audioData = synth.getAudioData();

            // Update spectrum display
            updateSpectrum();

            // Update and draw particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.update(mouseX, mouseY, audioData, intensity);
                
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                    // Spawn new particle
                    const colors = [
                        document.getElementById('colorInput1').value,
                        document.getElementById('colorInput2').value,
                        document.getElementById('colorInput3').value
                    ];
                    const shape = document.getElementById('shapeInput').value;
                    particles.push(new Particle(
                        Math.random() * canvas.width,
                        Math.random() * canvas.height,
                        colors,
                        shape
                    ));
                } else {
                    particle.draw(ctx);
                }
            }

            // Draw connections between nearby particles with dynamic colors
            const primaryColor = document.getElementById('colorInput1').value;
            ctx.strokeStyle = primaryColor + '20';
            ctx.lineWidth = 1;
            const connectionDistance = 80 + (audioData.average / 255) * 40;
            
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < connectionDistance) {
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.globalAlpha = (connectionDistance - distance) / connectionDistance * 0.3 * (1 + audioData.average / 255);
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }
                }
            }

            requestAnimationFrame(animate);
        }

        function updateSpectrum() {
            const spectrumCanvas = document.getElementById('spectrumCanvas');
            const specCtx = spectrumCanvas.getContext('2d');
            
            // Clear spectrum canvas
            specCtx.fillStyle = 'rgba(0, 20, 40, 0.8)';
            specCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);
            
            // Draw active frequencies
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById(`wave${i}Enable`).checked) {
                    const freq = parseInt(document.getElementById(`wave${i}Freq`).value) || 0;
                    const volume = parseInt(document.getElementById(`wave${i}Volume`).value) / 100;
                    const waveType = document.getElementById(`wave${i}Type`).value;
                    
                    if (freq > 0) {
                        // Map frequency to x position (logarithmic scale for better visualization)
                        const minFreq = 1;
                        const maxFreq = 20000;
                        const x = (Math.log(freq) - Math.log(minFreq)) / (Math.log(maxFreq) - Math.log(minFreq)) * spectrumCanvas.width;
                        const height = volume * spectrumCanvas.height * 0.8;
                        
                        // Color based on wave type
                        const colors = {
                            sine: '#66ccff',
                            square: '#ff6666', 
                            triangle: '#66ff66',
                            sawtooth: '#ffff66'
                        };
                        
                        specCtx.fillStyle = colors[waveType] || '#66ccff';
                        specCtx.fillRect(x - 2, spectrumCanvas.height - height, 4, height);
                        
                        // Frequency label
                        specCtx.fillStyle = 'white';
                        specCtx.font = '8px Arial';
                        specCtx.fillText(`${freq}Hz`, x - 10, spectrumCanvas.height - height - 5);
                    }
                }
            }
        }

        function resetVisualization() {
            createParticles();
        }

        function randomizeColors() {
            // Generate random colors
            document.getElementById('colorInput1').value = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            document.getElementById('colorInput2').value = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            document.getElementById('colorInput3').value = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            createParticles();
        }

        function harmonicColors() {
            // Generate harmonically related colors (triadic color scheme)
            const baseHue = Math.random() * 360;
            const saturation = 70 + Math.random() * 30; // 70-100%
            const lightness = 50 + Math.random() * 30;  // 50-80%
            
            document.getElementById('colorInput1').value = hslToHex(baseHue, saturation, lightness);
            document.getElementById('colorInput2').value = hslToHex((baseHue + 120) % 360, saturation, lightness);
            document.getElementById('colorInput3').value = hslToHex((baseHue + 240) % 360, saturation, lightness);
            createParticles();
        }

        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c / 2;
            let r = 0, g = 0, b = 0;
            
            if (0 <= h && h < 60) {
                r = c; g = x; b = 0;
            } else if (60 <= h && h < 120) {
                r = x; g = c; b = 0;
            } else if (120 <= h && h < 180) {
                r = 0; g = c; b = x;
            } else if (180 <= h && h < 240) {
                r = 0; g = x; b = c;
            } else if (240 <= h && h < 300) {
                r = x; g = 0; b = c;
            } else if (300 <= h && h < 360) {
                r = c; g = 0; b = x;
            }
            
            r = Math.round((r + m) * 255);
            g = Math.round((g + m) * 255);
            b = Math.round((b + m) * 255);
            
            return '#' + r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0');
        }

        // Healing frequency presets
        function loadPreset(presetName) {
            // Stop all waves first
            synth.stopAll();
            
            // Clear all checkboxes
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`wave${i}Enable`).checked = false;
            }
            
            const presets = {
                solfeggio: [
                    {freq: 396, type: 'sine', volume: 60},  // Liberation from Fear
                    {freq: 417, type: 'sine', volume: 60},  // Facilitating Change
                    {freq: 528, type: 'sine', volume: 70},  // Love Frequency / DNA Repair
                    {freq: 639, type: 'sine', volume: 65},  // Connection/Relationships
                    {freq: 741, type: 'sine', volume: 55},  // Awakening Intuition
                    {freq: 852, type: 'sine', volume: 55},  // Returning to Spiritual Order
                    {freq: 963, type: 'sine', volume: 50},  // Pineal Gland Activation
                    {freq: 63, type: 'sine', volume: 65}    // Deep Cellular Healing
                ],
                schumann: [
                    {freq: 7.83, type: 'sine', volume: 80},   // Fundamental Earth Resonance
                    {freq: 14.3, type: 'sine', volume: 60},   // 2nd Harmonic
                    {freq: 20.8, type: 'sine', volume: 50},   // 3rd Harmonic
                    {freq: 27.3, type: 'sine', volume: 45},   // 4th Harmonic
                    {freq: 33.8, type: 'sine', volume: 40},   // 5th Harmonic
                    {freq: 39.3, type: 'sine', volume: 35},   // 6th Harmonic
                    {freq: 45.9, type: 'sine', volume: 30}    // 7th Harmonic
                ],
                planetary: [
                    {freq: 141.27, type: 'sine', volume: 60}, // Mercury - Speech Control, Study Aid, Confidence
                    {freq: 221.23, type: 'sine', volume: 65}, // Venus - Beauty, Love, Sexuality, Sensuality, Harmony
                    {freq: 7.83, type: 'sine', volume: 70},   // Earth - Memory, Rejuvenation, Balance, Tolerance, Grounding
                    {freq: 144.72, type: 'sine', volume: 60}, // Mars - Energy, Humor, Strength, Focus of Will
                    {freq: 183.58, type: 'sine', volume: 65}, // Jupiter - Success, Growth, Creative, Power, Generosity
                    {freq: 147.85, type: 'sine', volume: 55}, // Saturn - Enhances Concentration, Karmic Connections, Structure and Order
                    {freq: 207.36, type: 'sine', volume: 55}, // Uranus - Universal Harmony, Calmness, Good Moods
                    {freq: 211.44, type: 'sine', volume: 50}  // Neptune - Lucid Dreams, Reveals Unconscious Thoughts
                ]
            };
            
            const preset = presets[presetName];
            if (preset) {
                preset.forEach((wave, index) => {
                    const waveNum = index + 1;
                    document.getElementById(`wave${waveNum}Freq`).value = wave.freq;
                    document.getElementById(`wave${waveNum}Type`).value = wave.type;
                    document.getElementById(`wave${waveNum}Volume`).value = wave.volume;
                    document.getElementById(`wave${waveNum}Enable`).checked = true;
                });
                
                // Update spectrum display after loading preset
                updateSpectrum();
            }
        }

        // Event listeners
        canvas.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // Wave synthesizer controls
        document.getElementById('playAll').addEventListener('click', () => synth.playAll());
        document.getElementById('stopAll').addEventListener('click', () => synth.stopAll());

        document.getElementById('masterVolume').addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            synth.setMasterVolume(volume);
            e.target.nextElementSibling.textContent = e.target.value + '%';
        });

        // Individual wave controls
        for (let i = 1; i <= 8; i++) {
            document.getElementById(`wave${i}Enable`).addEventListener('change', (e) => {
                if (e.target.checked && synth.isPlaying) {
                    synth.startWave(i);
                } else {
                    synth.stopWave(i);
                }
                updateSpectrum();
            });

            document.getElementById(`wave${i}Freq`).addEventListener('input', (e) => {
                if (document.getElementById(`wave${i}Enable`).checked && synth.isPlaying) {
                    synth.updateWave(i);
                }
                updateSpectrum();
            });

            document.getElementById(`wave${i}Type`).addEventListener('change', (e) => {
                if (document.getElementById(`wave${i}Enable`).checked && synth.isPlaying) {
                    synth.stopWave(i);
                    synth.startWave(i);
                }
                updateSpectrum();
            });

            document.getElementById(`wave${i}Volume`).addEventListener('input', (e) => {
                if (document.getElementById(`wave${i}Enable`).checked && synth.isPlaying) {
                    synth.updateWave(i);
                }
                updateSpectrum();
            });
        }

        document.getElementById('colorInput1').addEventListener('change', createParticles);
        document.getElementById('colorInput2').addEventListener('change', createParticles);
        document.getElementById('colorInput3').addEventListener('change', createParticles);
        document.getElementById('shapeInput').addEventListener('change', createParticles);

        window.addEventListener('resize', resizeCanvas);

        // Initialize
        resizeCanvas();
        createParticles();
        updateSpectrum(); // Initialize spectrum display
        animate();
    </script>
</body>
</html>
